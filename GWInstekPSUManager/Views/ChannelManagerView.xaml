<UserControl x:Class="GWInstekPSUManager.Views.ChannelManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:GWInstekPSUManager.Views"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:vm="clr-namespace:GWInstekPSUManager.ViewModels"

             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Список всех каналов -->
        <StackPanel Grid.Column="0" Orientation="Horizontal">
            <ListBox ItemsSource="{Binding DeviceViewModels}"
                     SelectedItem="{Binding SelectedViewModel}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel>
                            <TextBlock Text="{Binding DeviceName}"/>
                            <TextBlock Text="{Binding DeviceService.Connection.ConnectionName}"/>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <ListBox 
                 ItemsSource="{Binding SelectedViewModel.Channels}"
                 SelectionMode="Extended"
                 SelectedItem="{Binding SelectedChannel}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <StackPanel>
                            <TextBlock Text="{Binding DeviceName}"/>
                            <TextBlock Text="{Binding ChannelNumber, StringFormat='Канал {0}'}"/>
                            <TextBlock Text="{Binding IsEnabled, StringFormat='Статус: {0}'}"/>
                            <StackPanel Orientation="Vertical">
                                <Button Content="Add" 
        Command="{Binding DataContext.AddChannelToGroupCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"/>
                                <Button Content="Remove" 
        Command="{Binding DataContext.RemoveChannelFromGroupCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"/>
                            </StackPanel>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

        </StackPanel>

        <!-- Панель управления -->
        <StackPanel Grid.Column="1">
            <GroupBox Header="Selected Channel Details"
                          Visibility="{Binding SelectedChannels}">
                <ItemsControl ItemsSource="{Binding SelectedChannels}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <!-- UniformGrid автоматически создаёт равные ячейки -->
                            <UniformGrid Rows="2" Columns="2"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- Шаблон для каждого элемента (канала) -->
                            <Border BorderBrush="Gray" BorderThickness="1" Margin="2">
                                <local:PowerSupplyChannelView DataContext="{Binding}"/>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>

                    <!-- Заполнитель, если Channels пуст или null -->
                    <ItemsControl.Style>
                        <Style TargetType="ItemsControl">
                            <Style.Triggers>
                                <Trigger Property="HasItems" Value="False">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate>
                                                <!-- Пустой Grid с серой сеткой -->
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="*"/>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Border Grid.Row="0" Grid.Column="0" BorderBrush="LightGray" BorderThickness="1"/>
                                                    <Border Grid.Row="0" Grid.Column="1" BorderBrush="LightGray" BorderThickness="1"/>
                                                    <Border Grid.Row="1" Grid.Column="0" BorderBrush="LightGray" BorderThickness="1"/>
                                                    <Border Grid.Row="1" Grid.Column="1" BorderBrush="LightGray" BorderThickness="1"/>
                                                </Grid>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ItemsControl.Style>
                </ItemsControl>
            </GroupBox>

            <StackPanel>
                <CheckBox IsChecked="{Binding IsSeriesMode}" Content="Series"/>
                <CheckBox IsChecked="{Binding IsParallelMode}" Content="Parallel"/>

            </StackPanel>


            <Button Content="Включить/Выключить" 
                    Command="{Binding ToggleSelectedChannelsCommand}"/>

            <StackPanel Orientation="Horizontal" Margin="5">
                <xctk:DoubleUpDown Value="{Binding SelectedChannels[0].Vset, UpdateSourceTrigger=PropertyChanged}"
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Left"
                                                       Width="150"
                                                       Margin="5"
                                                       Background="#FF3F3F3F"
                                                       Foreground="#FFFFFFFF"
                                                       BorderBrush="#FF575757" 
                                                       Maximum="35" 
                                                       Minimum="0" 
                                                       Increment="0.01"/>
                <Button Content="Применить напряжение" 
                    Command="{Binding SetVoltageForSelectedCommand}"
                    CommandParameter="{Binding SelectedChannels[0].Vset}"/>

            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="5">
                <xctk:DoubleUpDown Value="{Binding SelectedChannels[0].Iset, UpdateSourceTrigger=PropertyChanged}"
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Left"
                                                       Width="150"
                                                       Margin="5"
                                                       Background="#FF3F3F3F"
                                                       Foreground="#FFFFFFFF"
                                                       BorderBrush="#FF575757" 
                                                       Maximum="3" 
                                                       Minimum="0" 
                                                       Increment="0.01"/>
                <Button Content="Применить ток" 
                    Command="{Binding SetCurrentForSelectedCommand}"
                    CommandParameter="{Binding SelectedChannels[0].Iset}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="10">
                <Button Content="CC Load mod" 
                    Command="{Binding SetCCLoadModeCommand}"
                        Margin="5 0" Padding="5"
                        Style="{StaticResource CCButtonStyle}"/>
                <Button Content="CV Load mod" 
                    Command="{Binding SetCVLoadModeCommand}"
                        Margin="5 0" Padding="5"
                        Style="{StaticResource CVButtonStyle}"/>
                <Button Content="CR Load mod" 
                    Command="{Binding SetCRLoadModeCommand}"
                        Margin="5 0" Padding="5"
                        Style="{StaticResource CRButtonStyle}"/>
            </StackPanel>
        </StackPanel>
    </Grid>
</UserControl>
